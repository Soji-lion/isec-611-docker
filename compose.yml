version: "3.8"

services:
  host:
    image: debian:bookworm
    container_name: host
    privileged: true
    tty: true
    stdin_open: true
    environment:
      - DISPLAY=$DISPLAY
    networks:
      client-net:
        ipv4_address: 192.168.71.3
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /dev/shm:/dev/shm:rw
      - $HOME/.Xauthority:/root/.Xauthority:rw
    command: |
      bash -c "
        apt-get update &&
        apt-get install -y firefox-esr dbus-x11 ca-certificates wget curl iputils-ping xz-utils kdialog &&
        mkdir -p /usr/lib/firefox-esr/distribution &&
        echo '
        {
          \"policies\": {
            \"ExtensionSettings\": {
              \"uBlock0@raymondhill.net\": {
                \"installation_mode\": \"force_installed\",
                \"install_url\": \"https://addons.mozilla.org/firefox/downloads/latest/ublock-origin/latest.xpi\"
              },
              \"jid1-MnnxcxisBPnSXQ@jetpack\": {
                \"installation_mode\": \"force_installed\",
                \"install_url\": \"https://addons.mozilla.org/firefox/downloads/latest/privacy-badger17/latest.xpi\"
              },
              \"{73a6fe31-595d-460b-a920-fcc0f8843232}\": {
                \"installation_mode\": \"force_installed\",
                \"install_url\": \"https://addons.mozilla.org/firefox/downloads/latest/noscript/latest.xpi\"
              }
            }
          }
        }' > /usr/lib/firefox-esr/distribution/policies.json &&
        echo 'Firefox + Extensions + ping Ready' &&

        wget https://www.torproject.org/dist/torbrowser/15.0.4/tor-browser-linux-x86_64-15.0.4.tar.xz &&
        tar -xvf tor-browser-linux-x86_64-15.0.4.tar.xz &&
        cd tor-browser &&
        sed -i '85,88d' ./Browser/start-tor-browser &&
        ./start-tor-browser.desktop &&
        cd / &&
        echo 'Tor Browser Ready' &&

        touch cleanup.sh &&
        echo 'TODO: add script to cleanup' &&
        chmod +x cleanup.sh &&
        echo \"sed -i '/browser.contentblocking.category/d'  /root/.mozilla/firefox/*.default-esr/prefs.js\" > cleanup.sh &&
        echo \"echo 'user_pref(\\\"browser.contentblocking.category\\\", \\\"standard\\\");' >> /root/.mozilla/firefox/*.default-esr/prefs.js\" >> cleanup.sh &&
        touch settings.sh &&
        echo './cleanup.sh' > settings.sh &&
        echo \"sed -i '/browser.contentblocking.category/d' /root/.mozilla/firefox/*.default-esr/prefs.js\" >> /settings.sh &&
        echo \"echo 'user_pref(\\\"browser.contentblocking.category\\\", \\\"strict\\\");' >> /root/.mozilla/firefox/*.default-esr/prefs.js\" >> settings.sh &&
        echo 'firefox' >> settings.sh &&
        chmod +x settings.sh &&

        sleep infinity
      "

  mitm:
    image: mitmproxy/mitmproxy:latest
    container_name: MITM
    command: mitmdump --listen-host 0.0.0.0 --listen-port 8080
    networks:
      client-net:
        ipv4_address: 192.168.71.2
      server-net:
        ipv4_address: 192.168.72.2
    ports:
      - "8080:8080"

  web:
    image: nginx:alpine
    container_name: web-server
    networks:
      server-net:
        ipv4_address: 192.168.72.4
    ports:
      - "8081:80"
    volumes:
      - ./webroot:/usr/share/nginx/html:ro
      - ./nginx-logs:/var/log/nginx:rw

networks:
  client-net:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.71.0/24
  server-net:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.72.0/24
